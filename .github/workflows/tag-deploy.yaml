name: Deploy on Tag

on:
  push:
    tags:
      - 'sv*'
      - 'v*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0   # ensures full history for merges

      - name: Set up Git
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

      - name: Determine branch
        id: branch
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          if [[ $TAG_NAME == sv* ]]; then
            echo "branch=staging" >> $GITHUB_ENV
          elif [[ $TAG_NAME == v* ]]; then
            echo "branch=production" >> $GITHUB_ENV

      - name: Ensure branch exists
        run: |
          if ! git show-ref --verify --quiet refs/heads/${{ env.branch }}; then
            git checkout -b ${{ env.branch }}
            git push origin ${{ env.branch }}
          else
            git checkout ${{ env.branch }}
          fi

      - name: Merge tag commit into branch
        run: |
          git merge $GITHUB_SHA --no-ff -m "Merge tag $GITHUB_REF into ${{ env.branch }}"
          git push origin ${{ env.branch }}